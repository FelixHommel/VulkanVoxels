name: Build and Test

on:
  pull_request:
    branches: [ main, dev ]
  push:
    branches: [ main, dev ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [ Debug, Release ]
        compiler:
          - { cc: gcc-13, cxx: g++-13 }
          - { cc: clang-19, cxx: clang++-19 }
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt install -y \
            cmake \
            ninja-build \
            gcc-13 \
            g++-13 \
            clang-19 \
            clang-tools-19 \
            libxkbcommon-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libgl1-mesa-dev
      - name: Install Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-query-version: latest
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true
      - name: Configure CMake
        env:
          CC: ${{ matrix.compiler.cc }}
          CXX: ${{ matrix.compiler.cxx }}
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }}
      - name: Run tests
        id: tests
        continue-on-error: ${{ github.ref != 'refs/heads/main' && github.base_ref != 'main' }}
        run: ctest --preset test-all
      - name: Test results
        if: failure() && steps.tests.outcome == 'failure'
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || \
             [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "Tests failed for main branch"
            exit 1
          else
            echo "Tests failed on dev branch - fix before merging"
          fi

  coverage:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt install -y \
            cmake \
            ninja-build \
            gcc-13 \
            g++-13 \
            lcov \
            libxkbcommon-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libgl1-mesa-dev
      - name: Install Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-query-version: 1.3.290.0
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true
      - name: Configure with coverage
        run: cmake --preset=code-coverage
      - name: Build
        run: cmake --build build/code-coverage
      - name: Run tests with coverage
        run: |
          cd build/code-coverage
          ctest --output-on-failure
      - name: Generate coverage report
        run: |
          lcov --capture --directory build/code-coverage \
            --output-file coverage.info \
            --ignore-errors mismatch
          lcov --remove coverage.info \
            '/usr/*' \
            '*/deps/*' \
            '*/tests/*' \
            --output-file coverage.info
          lcov --list coverage.info
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.info
          fail_ci_if_error: false

